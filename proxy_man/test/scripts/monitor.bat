@echo off
REM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
REM  æ€§èƒ½ç›‘æŽ§è„šæœ¬
REM
REM  åŠŸèƒ½ï¼š
REM    1. ç›‘æŽ§è¿›ç¨‹ CPU å’Œå†…å­˜ä½¿ç”¨çŽ‡
REM    2. è°ƒç”¨ä»£ç† /stats æŽ¥å£èŽ·å–å®žæ—¶ QPS
REM    3. è¾“å‡ºåˆ°æŽ§åˆ¶å°å’Œæ—¥å¿—æ–‡ä»¶
REM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

setlocal enabledelayedexpansion

set PROXY_URL=http://localhost:8080
set STATS_URL=%PROXY_URL%/stats
set LOG_FILE=..\results\monitor_%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%.log
set STATS_FILE=..\results\monitor_stats_%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%.csv

REM é¢œè‰²ä»£ç 
set GREEN=[92m
set YELLOW=[93m
set BLUE=[94m
set CYAN=[96m
set RESET=[0m

echo.
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo   %CYAN%ðŸ“Š æ€§èƒ½ç›‘æŽ§å·¥å…·%RESET%
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM åˆ›å»ºç»“æžœç›®å½•
if not exist "..\results" mkdir "..\results"

REM å†™å…¥ CSV å¤´éƒ¨
echo æ—¶é—´æˆ³,CPUä½¿ç”¨çŽ‡%%,å·¥ä½œé›†_MB,å¯ç”¨å†…å­˜_MB,QPS > "%STATS_FILE%"

echo %BLUE%â„¹ï¸ ç›‘æŽ§é…ç½®:%RESET%
echo   ä»£ç† URL: %PROXY_URL%
echo   æ—¥å¿—æ–‡ä»¶: %LOG_FILE%
echo   ç»Ÿè®¡æ–‡ä»¶: %STATS_FILE%
echo.
echo %YELLOW%âš  æŒ‰ Ctrl+C åœæ­¢ç›‘æŽ§%RESET%
echo.
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM ç›‘æŽ§å¾ªçŽ¯
set /a count=0
:loop
set /a count+=1

REM èŽ·å–å½“å‰æ—¶é—´æˆ³
for /f "tokens=1-3 delims=:." %%a in ("%time%") do (
    set timestamp=!date:~0,4!-!date:~5,2!-!date:~8,2! %%a:%%b:%%c
)

REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REM   1. èŽ·å–è¿›ç¨‹ CPU ä½¿ç”¨çŽ‡
REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set cpu=0
for /f "skip=1" %%p in ('typeperf "\Process(proxy_man)\%% Processor Time" -sc 1 2^>nul ^| findstr /r ","') do (
    for /f "tokens=2 delims=," %%v in ("%%p") do (
        set cpu=%%v
        set cpu=!cpu:"=!
    )
)

REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REM   2. èŽ·å–è¿›ç¨‹å†…å­˜ä½¿ç”¨ (å·¥ä½œé›†)
REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set ws=0
for /f "skip=1" %%p in ('typeperf "\Process(proxy_man)\Working Set" -sc 1 2^>nul ^| findstr /r ","') do (
    for /f "tokens=2 delims=," %%v in ("%%p") do (
        set ws=%%v
        set ws=!ws:"=!
        set /a ws_mb=!ws! / 1048576
    )
)

REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REM   3. èŽ·å–ç³»ç»Ÿå¯ç”¨å†…å­˜
REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set avail=0
for /f "skip=1" %%p in ('typeperf "\Memory\Available MBytes" -sc 1 2^>nul ^| findstr /r ","') do (
    for /f "tokens=2 delims=," %%v in ("%%p") do (
        set avail=%%v
        set avail=!avail:"=!
    )
)

REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REM   4. èŽ·å–ä»£ç† QPS ç»Ÿè®¡
REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set qps=N/A
for /f "tokens=*" %%q in ('curl -s "%STATS_URL%" 2^>nul ^| findstr /i "qps requests"') do (
    set qps=%%q
)

REM æ¸…ç† QPS å­—ç¬¦ä¸²ï¼ˆæå–æ•°å­—ï¼‰
for /f "tokens=2" %%n in ("!qps!") do set qps_num=%%n
if defined qps_num (
    set qps=!qps_num!
) else (
    set qps=0
)

REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REM   5. è¾“å‡ºç»“æžœ
REM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo [!count!] !timestamp! | CPU: !cpu!%% | MEM: !ws_mb! MB | Avail: !avail! MB | QPS: !qps!
echo !timestamp!,!cpu!,!ws_mb!,!avail!,!qps! >> "%STATS_FILE%"

REM æ¯ 60 æ¬¡è¾“å‡ºåˆ†éš”çº¿
set /a mod=count %% 60
if !mod! equ 0 (
    echo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
)

REM ç­‰å¾… 1 ç§’
timeout /t 1 >nul

goto loop

endlocal